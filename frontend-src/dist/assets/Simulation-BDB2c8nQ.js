import{j as e,u as Se}from"./index-BrymJBK1.js";import{b as s,e as Be,f as Me}from"./vendor-iPqs1NIt.js";import{u as Y}from"./shared-BQOe6qjF.js";import{L as Pe,D as Le,u as Oe,a as Fe,S as Ne,b as qe,c as Je,A as Ue,d as oe}from"./AnalysisModal-CwODF3pg.js";async function ve(r){const i=await fetch("/api/tts/intro",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:r})});if(!i.ok)throw new Error("TTS failed");return(await i.json()).url}function ue(r,{volume:i=1,loop:f=!1}={}){return new Promise((t,d)=>{const y=new Audio(r);y.volume=i,y.loop=f,y.onended=()=>t(y),y.onerror=n=>d(n),y.play().then(()=>{f&&t(y)}).catch(d)})}function se(r,i){return new Promise((f,t)=>{const d=setTimeout(f,r);i&&i.addEventListener("abort",()=>{clearTimeout(d),t(new DOMException("Aborted","AbortError"))},{once:!0})})}function He(){const[r,i]=s.useState(!1),f=s.useRef(null),t=s.useRef(null),d=s.useRef([]);s.useEffect(()=>()=>{f.current&&f.current.abort(),d.current.forEach(p=>{p.pause(),p.src=""}),d.current=[],t.current&&(t.current.pause(),t.current.src="",t.current=null)},[]);const y=s.useCallback(async p=>{var j;f.current&&f.current.abort();const v=new AbortController;f.current=v;const a=v.signal;i(!0);try{const g=((j=p==null?void 0:p.persona)==null?void 0:j.identite)||{},A=g.nom||"le prospect",u=(g.genre||"M")==="F"?"Madame":"Monsieur",C=(p==null?void 0:p.intro_assistante)||{},E=C.accueil||`Bonjour, vous avez rendez-vous avec ${u.toLowerCase()==="madame"?"madame":"monsieur"} ${A} ? Un instant je vous prie.`,B=C.introduction||`${u} ${A} vous re√ßoit, installez-vous.`,[M,P]=await Promise.all([ve(E),ve(B)]);if(a.aborted)throw new DOMException("Aborted","AbortError");const T=new Audio("/static/sounds/office_ambiance.mp3");if(T.loop=!0,T.volume=.15,t.current=T,d.current.push(T),await T.play(),a.aborted)throw new DOMException("Aborted","AbortError");await se(1500,a);const L=await ue(M,{volume:.85});if(d.current.push(L),a.aborted)throw new DOMException("Aborted","AbortError");await se(1e3,a);const _=await ue("/static/sounds/door_open.mp3",{volume:.7});if(d.current.push(_),a.aborted)throw new DOMException("Aborted","AbortError");await se(500,a);const m=await ue(P,{volume:.85});if(d.current.push(m),a.aborted)throw new DOMException("Aborted","AbortError");await se(500,a),i(!1)}catch(g){if(i(!1),g.name==="AbortError")return;throw g}},[]),n=s.useCallback((p=2e3)=>{const v=t.current;if(!v)return;const a=v.volume,j=20,g=p/j,A=a/j;let o=0;const u=setInterval(()=>{o++,v.volume=Math.max(0,a-A*o),o>=j&&(clearInterval(u),v.pause(),v.src="",t.current=null)},g)},[]),S=s.useCallback(()=>{f.current&&f.current.abort(),d.current.forEach(p=>{p.pause(),p.src=""}),d.current=[],t.current&&(t.current.pause(),t.current.src="",t.current=null),i(!1)},[]);return{play:y,stop:S,fadeOutAmbiance:n,isPlaying:r}}function ae({title:r,icon:i,children:f,fullWidth:t}){const d=Y();return e.jsxs("div",{style:{background:d.bgC,border:`1px solid ${d.bd}`,borderRadius:10,padding:16,gridColumn:t?"1 / -1":void 0},children:[e.jsxs("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:d.dm,marginBottom:10,display:"flex",alignItems:"center",gap:6},children:[i," ",r]}),e.jsx("div",{style:{fontSize:13.5,lineHeight:1.6,color:d.mt},children:f})]})}function Ge({scenario:r,language:i,difficulty:f,onLanguageChange:t,onDifficultyChange:d,onLaunch:y}){const n=Y();if(!r)return null;const S=r.persona,p=S.identite,v=p.entreprise,a=S.psychologie,j=S.contexte_actuel,g=r.objections,A=((g==null?void 0:g.objections)||[]).slice(0,6);return e.jsxs("div",{children:[e.jsxs("div",{className:"sim-brief-grid",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,marginBottom:24},children:[e.jsxs(ae,{title:"Profil",icon:"üë§",children:[e.jsxs("strong",{style:{color:n.tx,fontWeight:600},children:[p.prenom," ",p.nom]}),", ",p.age||"?"," ans",e.jsx("br",{}),p.poste," chez ",e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:v.nom}),e.jsx("br",{}),v.secteur," ‚Äî ",v.taille||"?"," ‚Äî CA ",v.ca_approximatif||"?"]}),e.jsxs(ae,{title:"Psychologie",icon:"üß†",children:[e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Traits :"})," ",a.traits_dominants.join(", "),e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Style :"})," ",a.style_communication,e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Rapport aux commerciaux :"})," ",a.rapport_aux_commerciaux||"?"]}),e.jsxs(ae,{title:"Contexte",icon:"üìã",fullWidth:!0,children:[e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Situation :"})," ",j.situation_entreprise,e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Priorit√©s :"})," ",(j.priorites_actuelles||[]).join(", "),e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Fournisseur actuel :"})," ",j.fournisseur_actuel||"Aucun",e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Budget :"})," ",j.budget_disponible||"?"]}),e.jsx(ae,{title:"Objections √† anticiper",icon:"‚ö°",fullWidth:!0,children:A.length>0?e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:A.map((o,u)=>e.jsxs("div",{style:{background:n.bgE,border:`1px solid ${n.bd}`,borderRadius:6,padding:"10px 12px",fontSize:13,lineHeight:1.5},children:[e.jsx("span",{style:{fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:.8,color:n.ac,marginRight:8},children:o.moment}),e.jsxs("span",{style:{float:"right",fontSize:10,color:n.dm,fontFamily:"'JetBrains Mono', monospace"},children:["diff: ",o.difficulte,"/5"]}),e.jsx("br",{}),e.jsxs("span",{style:{color:n.tx,fontStyle:"italic"},children:['"',o.verbatim,'"']})]},u))}):"Aucune objection d√©finie."})]}),e.jsxs("div",{style:{marginBottom:24},children:[e.jsx("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:n.dm,marginBottom:10,textAlign:"center"},children:"Langue de la simulation"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"},children:Pe.map(o=>e.jsxs("button",{onClick:()=>t(o.code),style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 16px",borderRadius:20,fontSize:13,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:i===o.code?n.acD:"transparent",border:`1px solid ${i===o.code?n.ac:n.bd}`,color:i===o.code?n.ac:n.mt,boxShadow:i===o.code?`0 0 12px ${n.acD}`:"none",fontFamily:"inherit"},children:[e.jsx("span",{style:{fontSize:18,lineHeight:1},children:o.flag})," ",o.label]},o.code))})]}),e.jsxs("div",{style:{marginBottom:24},children:[e.jsx("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:n.dm,marginBottom:10,textAlign:"center"},children:"Niveau de difficult√©"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"},children:Le.map(o=>{const u=f===o.value,C={1:n.ok,2:n.wr,3:n.dn},E={1:n.okD,2:n.wrD,3:n.dnD};return e.jsxs("button",{onClick:()=>d(o.value),style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4,padding:"10px 18px",borderRadius:20,fontSize:13,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:u?E[o.value]:"transparent",border:`1px solid ${u?C[o.value]:n.bd}`,color:u?C[o.value]:n.mt,boxShadow:u?`0 0 12px ${E[o.value]}`:"none",textAlign:"center",fontFamily:"inherit"},children:[e.jsxs("span",{style:{fontSize:13,fontWeight:600},children:[o.emoji," ",o.label]}),e.jsx("span",{style:{fontSize:10,fontWeight:400,color:u?"inherit":n.dm,maxWidth:170,lineHeight:1.3,opacity:u?.8:1},children:o.desc})]},o.value)})})]}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center",marginTop:28},children:e.jsx("button",{onClick:y,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:`linear-gradient(135deg, ${n.ac}, ${n.acL})`,color:"#fff",boxShadow:`0 4px 16px ${n.acD}`,fontFamily:"inherit"},children:"üéôÔ∏è Lancer la simulation"})})]})}const Ve=[{value:"",label:"D√©tection automatique"},{value:"industrie",label:"Industrie / Manufacturing"},{value:"services",label:"Services aux entreprises"},{value:"tech",label:"Tech / SaaS / Digital"},{value:"commerce",label:"Commerce / Distribution"},{value:"sante",label:"Sant√© / M√©dical"},{value:"batiment",label:"BTP / B√¢timent"},{value:"finance",label:"Finance / Assurance / Banque"},{value:"formation",label:"Formation / √âducation"},{value:"immobilier",label:"Immobilier"},{value:"autre",label:"Autre"}],Ke=[{value:"prospection",label:"Prospection √† froid"},{value:"relance",label:"Relance / Suivi"},{value:"negociation",label:"N√©gociation"},{value:"reclamation",label:"R√©clamation client"},{value:"upsell",label:"Upsell / Cross-sell"}],pe=["√âtape 1/4 : Analyse de votre situation...","√âtape 2/4 : Cr√©ation du prospect...","√âtape 3/4 : G√©n√©ration des objections...","√âtape 4/4 : Pr√©paration du brief commercial..."];function Ye({language:r,onBack:i,onLaunchScenario:f}){var P,T,L,_,m,I,O,z,Q,D,X,R,Z,$,ee;const t=Y(),{token:d}=Se(),[y,n]=s.useState(""),[S,p]=s.useState(""),[v,a]=s.useState("prospection"),[j,g]=s.useState(!1),[A,o]=s.useState(""),[u,C]=s.useState(null),E=s.useRef(null),B={width:"100%",padding:"10px 14px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:13,cursor:"pointer",fontFamily:"inherit"};async function M(){if(!y||y.length<30){alert("D√©crivez votre situation en au moins quelques phrases (30 caract√®res minimum).");return}g(!0),C(null),o(pe[0]);let x=0;E.current=setInterval(()=>{x=Math.min(x+1,pe.length-1),o(pe[x])},4e3);try{const F={"Content-Type":"application/json"};d&&(F.Authorization="Bearer "+d);const N=await fetch("/api/scenarios/generate",{method:"POST",headers:F,body:JSON.stringify({description:y,sector:S||null,type:v||"prospection",language:r})});clearInterval(E.current);const q=await N.json();if(!N.ok)throw new Error(q.detail||q.error||"Erreur serveur");C(q)}catch(F){alert("Erreur lors de la g√©n√©ration : "+F.message)}finally{clearInterval(E.current),g(!1)}}return e.jsxs("div",{children:[e.jsx("h2",{style:{textAlign:"center",fontSize:22,fontWeight:700,marginBottom:8},children:"Cr√©ez votre sc√©nario de simulation"}),e.jsx("p",{style:{textAlign:"center",color:t.mt,fontSize:14,marginBottom:24,lineHeight:1.6},children:"D√©crivez la situation commerciale que vous voulez entra√Æner. L'IA g√©n√®re tout automatiquement : le prospect, ses objections et le brief commercial."}),!j&&!u&&e.jsxs(e.Fragment,{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:8,display:"block"},children:"D√©crivez votre situation commerciale"}),e.jsx("textarea",{value:y,onChange:x=>n(x.target.value),rows:6,placeholder:"Ex: Je vends des logiciels de comptabilit√© aux cabinets comptables de 5-20 personnes...",style:{width:"100%",padding:16,borderRadius:10,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,lineHeight:1.6,resize:"vertical",fontFamily:"inherit",outline:"none"}}),e.jsxs("div",{className:"sim-creator-options",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,margin:"18px 0"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:6,display:"block"},children:"Secteur (optionnel)"}),e.jsx("select",{value:S,onChange:x=>p(x.target.value),style:B,children:Ve.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),e.jsxs("div",{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:6,display:"block"},children:"Type d'appel"}),e.jsx("select",{value:v,onChange:x=>a(x.target.value),style:B,children:Ke.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]})]})]}),j&&e.jsxs("div",{style:{textAlign:"center",padding:"32px 20px"},children:[e.jsx("div",{style:{display:"inline-block",width:36,height:36,border:`3px solid ${t.bd}`,borderTopColor:t.ac,borderRadius:"50%",animation:"spin 0.6s linear infinite",marginBottom:16}}),e.jsx("style",{children:"@keyframes spin { to { transform: rotate(360deg); } }"}),e.jsx("div",{style:{fontSize:15,fontWeight:600,marginBottom:4},children:"G√©n√©ration en cours..."}),e.jsx("div",{style:{fontSize:12,color:t.dm},children:"L'IA cr√©e votre prospect, ses objections et le brief commercial."}),e.jsx("div",{style:{fontSize:13,color:t.ac,fontWeight:600,marginTop:8},children:A})]}),u&&e.jsxs("div",{style:{background:t.bgC,border:`1px solid ${t.bd}`,borderRadius:14,padding:24,marginTop:20},children:[e.jsx("h3",{style:{fontSize:18,fontWeight:700,marginBottom:16,color:t.ok},children:"Sc√©nario g√©n√©r√© avec succ√®s"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,fontSize:14,color:t.mt,marginBottom:20},children:[e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Prospect :"})," ",(T=(P=u.persona)==null?void 0:P.identite)==null?void 0:T.prenom," ",(_=(L=u.persona)==null?void 0:L.identite)==null?void 0:_.nom,", ",(I=(m=u.persona)==null?void 0:m.identite)==null?void 0:I.poste]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Entreprise :"})," ",(Q=(z=(O=u.persona)==null?void 0:O.identite)==null?void 0:z.entreprise)==null?void 0:Q.nom," ‚Äî ",(R=(X=(D=u.persona)==null?void 0:D.identite)==null?void 0:X.entreprise)==null?void 0:R.secteur]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Titre :"})," ",((Z=u.brief_commercial)==null?void 0:Z.titre)||"Sc√©nario personnalis√©"]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Objections :"})," ",((ee=($=u.objections)==null?void 0:$.objections)==null?void 0:ee.length)||"?"," objections g√©n√©r√©es"]})]}),e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",flexWrap:"wrap"},children:[e.jsx("button",{onClick:()=>f(u.id||u.scenario_id),style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",boxShadow:`0 4px 16px ${t.acD}`,fontFamily:"inherit"},children:"Lancer la simulation"}),e.jsx("button",{onClick:()=>{C(null),g(!1)},style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"Modifier et r√©g√©n√©rer"})]})]}),!j&&!u&&e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",marginTop:28},children:[e.jsx("button",{onClick:M,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",boxShadow:`0 4px 16px ${t.acD}`,fontFamily:"inherit"},children:"G√©n√©rer le sc√©nario"}),e.jsx("button",{onClick:i,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"Retour"})]})]})}function Qe({open:r,onClose:i,onLogin:f}){const t=Y();return r?e.jsx("div",{onClick:d=>{d.target===d.currentTarget&&i()},style:{position:"fixed",inset:0,zIndex:9999,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(6px)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{background:t.bgC,border:`1px solid ${t.bd}`,borderRadius:18,padding:"36px 32px",maxWidth:440,width:"90%",textAlign:"center",boxShadow:"0 24px 64px rgba(0,0,0,0.5)",position:"relative"},children:[e.jsx("button",{onClick:i,style:{position:"absolute",top:16,right:16,background:"none",border:"none",color:t.dm,fontSize:20,cursor:"pointer"},children:"√ó"}),e.jsx("div",{style:{fontSize:44,marginBottom:16},children:"üöÄ"}),e.jsx("div",{style:{fontSize:20,fontWeight:700,marginBottom:8},children:"Impressionn√© par votre simulation ?"}),e.jsxs("div",{style:{fontSize:14,color:t.mt,lineHeight:1.6,marginBottom:24},children:["Vous avez utilis√© votre simulation gratuite.",e.jsx("br",{}),"Cr√©ez un compte pour acc√©der √† ",e.jsx("strong",{style:{color:t.tx},children:"12 sc√©narios"}),", tous les niveaux de difficult√©, et suivre votre progression."]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:10},children:[e.jsx("a",{href:"/contact",style:{display:"block",padding:"14px 20px",borderRadius:6,background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",fontSize:14,fontWeight:600,textDecoration:"none",textAlign:"center",boxShadow:`0 4px 16px ${t.acD}`},children:"Cr√©er mon compte gratuitement"}),e.jsx("button",{onClick:f,style:{padding:"12px 20px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"J'ai d√©j√† un compte ‚Äî Se connecter"})]})]})}):null}function nt(){var he,be;const r=Y(),{token:i}=Se(),f=Be(),[t]=Me(),d=t.get("scenario")||"__default__",y=!0,[n,S]=s.useState("loading"),[p,v]=s.useState(""),[a,j]=s.useState(null),[g,A]=s.useState(d),[o,u]=s.useState("fr"),[C,E]=s.useState(2),[B,M]=s.useState(!1),[P,T]=s.useState(null),[L,_]=s.useState(0),[m,I]=s.useState(null),[O,z]=s.useState(!1),[Q,D]=s.useState(""),[X,R]=s.useState(!1),[Z,$]=s.useState(0),[ee,x]=s.useState(0),[F,N]=s.useState(!1),q=s.useRef(null),te=s.useRef(0),ne=Oe(),J=He(),k=Fe(),U=s.useRef(null);s.useEffect(()=>{le(d)},[d]);async function le(c){var l;S("loading"),I(null),z(!1),D("");try{const w=await fetch("/api/scenarios/"+encodeURIComponent(c));if(!w.ok){const W=await w.json().catch(()=>({}));throw new Error(W.detail||"Sc√©nario introuvable")}const h=await w.json();j(h),A(c),E(((l=h.metadata)==null?void 0:l.difficulte_defaut)||2),S("briefing")}catch(w){v(w.message),S("error")}}async function je(){try{const c={"Content-Type":"application/json"};i&&(c.Authorization="Bearer "+i);const l=await fetch("/api/token",{method:"POST",headers:c,body:JSON.stringify({scenario_id:g!=="__default__"?g:null,difficulty:C,user_name:"Commercial",language:o})});l.ok&&(U.current=await l.json())}catch{}}const[we,fe]=s.useState(!1);function Ce(){S("call"),je()}s.useEffect(()=>{if(n==="postcall"&&m&&!O&&!i){const c=setTimeout(()=>fe(!0),8e3);return()=>clearTimeout(c)}},[n,m,O,i]);const ce=((he=a==null?void 0:a.simulation)==null?void 0:he.type)==="rdv_physique"||(a==null?void 0:a.scenario_type)==="rdv_physique";async function ke(){const c={tokenUrl:"/api/token",scenarioId:g!=="__default__"?g:null,difficulty:C,userName:"Commercial",language:o,authToken:i,prefetchedToken:U.current};if(ce)try{await J.play(a);const l=await k.connect({...c,onPickup:()=>J.fadeOutAmbiance(2e3)});U.current=null,T(l.sessionDbId)}catch{U.current=null,J.stop()}else{await ne.play();try{const l=await k.connect({...c,onPickup:()=>ne.stop()});U.current=null,T(l.sessionDbId)}catch{U.current=null,ne.stop()}}}function ze(){ne.stop(),J.stop();const c=k.disconnect(),l=k.transcriptEntries,w=l.length>0,h=c>3e3;w&&h?(_(c),S("postcall"),Ee(c,l)):S("briefing")}function ge(c){try{let l=c.replace(/```json/g,"").replace(/```/g,"").trim();const w=l.indexOf("{"),h=l.lastIndexOf("}");if(w===-1)return null;if(h>w)try{const b=JSON.parse(l.slice(w,h+1));if(b&&typeof b.score_global=="number")return b}catch{}l=l.slice(w),l=l.replace(/,\s*$/,"");let W=0,V=0;for(const b of l)b==="{"?W++:b==="}"?W--:b==="["?V++:b==="]"&&V--;l=l.replace(/,\s*$/,"");for(let b=0;b<V;b++)l+="]";for(let b=0;b<W;b++)l+="}";const K=JSON.parse(l);return K&&typeof K.score_global=="number"?K:null}catch{return null}}function Ae(){te.current++;const c=Date.now()-q.current,l=Math.min(Math.floor(c/2e3),oe.length-1),w=Math.min(Math.floor(te.current/3),oe.length-1),h=Math.max(l,w);x(h),$(oe[h].pct)}function xe(c){N(!0),$(100),x(oe.length-1),setTimeout(()=>{R(!1),N(!1),$(0),x(0),te.current=0,c&&c()},800)}async function Ee(c,l){if(z(!0),D(""),I(null),l.length<3){z(!1),D("Appel trop court pour √™tre √©valu√© (minimum 3 √©changes requis)");return}R(!0),$(0),x(0),N(!1),q.current=Date.now(),te.current=0;const w=l.map(h=>({role:h.who==="user"?"vendeur":"prospect",text:h.text,timestamp:h.time/1e3}));try{const h={"Content-Type":"application/json"};i&&(h.Authorization="Bearer "+i);const W=await fetch("/api/evaluate/stream",{method:"POST",headers:h,body:JSON.stringify({session_id:"free-"+g+"-"+Date.now(),transcript:w,scenario_id:g,difficulty:C,duration_s:Math.floor(c/1e3),session_db_id:P,language:o})});if(!W.ok){const H=await W.json().catch(()=>({}));throw new Error(H.detail||"Erreur serveur")}const V=W.body.getReader(),K=new TextDecoder;let b="",de="";for(;;){const{done:H,value:_e}=await V.read();if(H)break;de+=K.decode(_e,{stream:!0});const ye=de.split(`
`);de=ye.pop();for(const re of ye){if(re.startsWith("event: done")||re.startsWith("event: error")||!re.startsWith("data: "))continue;const $e=re.slice(6);try{const G=JSON.parse($e);if(G.type==="chunk"){b+=G.text,Ae();const ie=ge(b);ie&&I(ie)}else if(G.score_global!==void 0){const ie=G;xe(()=>{I(ie),z(!1),i||localStorage.setItem("vm-free-used","true")});return}else if(G.error){R(!1),D(G.error),z(!1);return}}catch{}}}if(b){const H=ge(b);if(H){xe(()=>{I(H),z(!1),i||localStorage.setItem("vm-free-used","true")});return}}R(!1),z(!1),i||localStorage.setItem("vm-free-used","true")}catch(h){R(!1),z(!1),D(h.message)}}function Te(){I(null),z(!1),D(""),_(0),le(g)}function Ie(){if(!i){M(!0);return}S("creator")}function De(c){f("/simulation?scenario="+encodeURIComponent(c)),le(c)}const me=((be=a==null?void 0:a.persona)==null?void 0:be.identite)||null,We=(a==null?void 0:a.brief_commercial)||{},Re=(()=>{const c=k.timer.split(":");return c.length!==2?0:parseInt(c[0],10)*60+parseInt(c[1],10)})();return e.jsxs("div",{style:{position:"relative",zIndex:1,maxWidth:860,margin:"0 auto",padding:"32px 24px",minHeight:"100vh"},children:[e.jsx("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:0,background:ce&&n==="call"?"radial-gradient(ellipse at center, rgba(20,30,50,0.8) 0%, #080D1A 70%)":`radial-gradient(ellipse at 15% -10%, ${r.ac}12 0%, transparent 55%), radial-gradient(ellipse at 85% 110%, ${r.bl}0A 0%, transparent 55%)`}}),e.jsxs("div",{style:{textAlign:"center",marginBottom:36,position:"relative",zIndex:1},children:[e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:10,marginBottom:16},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:10,background:`linear-gradient(135deg, ${r.ac}, ${r.acL})`,display:"grid",placeItems:"center",fontWeight:800,fontSize:16,color:"#fff",boxShadow:`0 2px 16px ${r.acD}`},children:"VM"}),e.jsxs("div",{style:{fontSize:20,fontWeight:700,letterSpacing:-.5},children:["Vend",e.jsx("span",{style:{color:r.ac},children:"Mieux"})]})]}),e.jsx("div",{style:{fontSize:24,fontWeight:700,marginBottom:6,letterSpacing:-.3},children:n==="loading"?"Chargement...":We.titre||"Simulation libre"}),e.jsx("div",{style:{color:r.mt,fontSize:14},children:"Simulation FORCE 3D ‚Äî Entra√Ænement commercial par IA"}),e.jsx("div",{style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:20,fontSize:12,fontWeight:600,background:r.acD,border:`1px solid ${r.ac}33`,color:r.ac,marginTop:12},children:"Mode libre"}),n!=="loading"&&e.jsx("div",{style:{marginTop:12},children:e.jsx("button",{onClick:Ie,style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 16px",borderRadius:20,fontSize:12,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:"transparent",border:`1px solid ${r.ac}`,color:r.ac,fontFamily:"inherit"},children:"+ Cr√©er un sc√©nario"})})]}),e.jsxs("div",{style:{position:"relative",zIndex:1},children:[n==="loading"&&e.jsxs("div",{style:{textAlign:"center",padding:"80px 20px"},children:[e.jsx("div",{style:{display:"inline-block",width:36,height:36,border:`3px solid ${r.bd}`,borderTopColor:r.ac,borderRadius:"50%",animation:"spin 0.6s linear infinite"}}),e.jsx("style",{children:"@keyframes spin { to { transform: rotate(360deg); } }"})]}),n==="error"&&e.jsxs("div",{style:{textAlign:"center",padding:"80px 20px"},children:[e.jsx("div",{style:{fontSize:48,marginBottom:16},children:"‚ö†Ô∏è"}),e.jsx("div",{style:{fontSize:16,color:r.mt},children:p||"Lien invalide ou expir√©."})]}),n==="briefing"&&a&&e.jsx(Ge,{scenario:a,language:o,difficulty:C,onLanguageChange:u,onDifficultyChange:E,onLaunch:Ce}),n==="call"&&e.jsx(Ne,{persona:me,status:J.isPlaying?"intro":k.status,statusMsg:J.isPlaying?"Arriv√©e dans les locaux...":k.statusMsg,timer:k.timer,muted:k.muted,transcriptEntries:k.transcriptEntries,pendingSegments:k.pendingSegments,onStart:ke,onMute:k.toggleMute,onStop:ze,isRdvPhysique:ce,scenario:a,elapsedSeconds:Re}),n==="postcall"&&e.jsx(qe,{persona:me,duration:L,transcriptEntries:k.transcriptEntries,evalLoading:O,evalError:Q,children:m&&e.jsx(Je,{evaluation:m,transcriptEntries:k.transcriptEntries,isFreeMode:y})}),n==="creator"&&e.jsx(Ye,{language:o,onBack:()=>S(a?"briefing":"loading"),onLaunchScenario:De})]}),n==="postcall"&&e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",flexWrap:"wrap",marginTop:28},children:[m&&m.eval_id&&i&&e.jsx("a",{href:"/debrief?session="+m.eval_id,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",textDecoration:"none",background:`linear-gradient(135deg, ${r.ac}, ${r.acL})`,color:"#fff",boxShadow:`0 4px 16px ${r.acD}`,fontFamily:"inherit"},children:"üìä Voir le d√©brief complet"}),e.jsx("button",{onClick:Te,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,fontSize:14,fontWeight:600,cursor:"pointer",background:m&&m.eval_id&&i?"transparent":`linear-gradient(135deg, ${r.ac}, ${r.acL})`,color:m&&m.eval_id&&i?r.mt:"#fff",border:m&&m.eval_id&&i?`1px solid ${r.bd}`:"none",boxShadow:m&&m.eval_id&&i?"none":`0 4px 16px ${r.acD}`,fontFamily:"inherit"},children:"üîÑ Nouvelle session"})]}),e.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",borderTop:`1px solid ${r.bd}`,marginTop:40},children:[e.jsx("div",{style:{color:r.mt,fontSize:14,marginBottom:12},children:"Cette simulation est propuls√©e par l'IA VendMieux"}),e.jsx("div",{style:{color:r.ac,fontSize:16,fontWeight:700},children:"Vous voulez √ßa pour vos √©tudiants ? Contactez-nous"})]}),X&&e.jsx(Ue,{progress:Z,currentStep:ee,done:F}),e.jsx(Qe,{open:B||we,onClose:()=>{M(!1),fe(!1)},onLogin:()=>{window.location.href="/login"}})]})}export{nt as default};
