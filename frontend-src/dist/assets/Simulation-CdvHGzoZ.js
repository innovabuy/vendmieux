import{j as e,u as ke}from"./index-DLesu0IO.js";import{b as o,e as Ue,f as Ve}from"./vendor-iPqs1NIt.js";import{u as Q}from"./shared-BFQ76nV-.js";import{L as He,D as Ge,u as Ke,a as Ye,S as Qe,b as Xe,c as Ze,A as et,d as ie}from"./AnalysisModal-Bubg7ML5.js";async function Ce(n){const i=await fetch("/api/tts/intro",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n})});if(!i.ok)throw new Error("TTS failed");return(await i.json()).url}function fe(n,{volume:i=1,loop:m=!1}={}){return new Promise((t,u)=>{const x=new Audio(n);x.volume=i,x.loop=m,x.onended=()=>t(x),x.onerror=r=>u(r),x.play().then(()=>{m&&t(x)}).catch(u)})}function oe(n,i){return new Promise((m,t)=>{const u=setTimeout(m,n);i&&i.addEventListener("abort",()=>{clearTimeout(u),t(new DOMException("Aborted","AbortError"))},{once:!0})})}function tt(){const[n,i]=o.useState(!1),m=o.useRef(null),t=o.useRef(null),u=o.useRef([]);o.useEffect(()=>()=>{m.current&&m.current.abort(),u.current.forEach(g=>{g.pause(),g.src=""}),u.current=[],t.current&&(t.current.pause(),t.current.src="",t.current=null)},[]);const x=o.useCallback(async g=>{var S;m.current&&m.current.abort();const d=new AbortController;m.current=d;const f=d.signal;i(!0);try{const j=((S=g==null?void 0:g.persona)==null?void 0:S.identite)||{},p=j.nom||"le prospect",s=(j.genre||"M")==="F"?"Madame":"Monsieur",A=(g==null?void 0:g.intro_assistante)||{},C=A.accueil||`Bonjour, vous avez rendez-vous avec ${s.toLowerCase()==="madame"?"madame":"monsieur"} ${p} ? Un instant je vous prie.`,q=A.introduction||`${s} ${p} vous re√ßoit, installez-vous.`,[D,P]=await Promise.all([Ce(C),Ce(q)]);if(f.aborted)throw new DOMException("Aborted","AbortError");const T=new Audio("/static/sounds/office-ambiance.mp3");if(T.loop=!0,T.volume=.15,t.current=T,u.current.push(T),await T.play(),f.aborted)throw new DOMException("Aborted","AbortError");await oe(1500,f);const M=await fe(D,{volume:.85});if(u.current.push(M),f.aborted)throw new DOMException("Aborted","AbortError");await oe(1e3,f);const J=await fe("/static/sounds/door_open.mp3",{volume:.7});if(u.current.push(J),f.aborted)throw new DOMException("Aborted","AbortError");await oe(500,f);const B=await fe(P,{volume:.85});if(u.current.push(B),f.aborted)throw new DOMException("Aborted","AbortError");await oe(500,f),i(!1)}catch(j){if(i(!1),j.name==="AbortError")return;throw j}},[]),r=o.useCallback((g=2e3)=>{const d=t.current;if(!d)return;const f=d.volume,S=20,j=g/S,p=f/S;let a=0;const s=setInterval(()=>{a++,d.volume=Math.max(0,f-p*a),a>=S&&(clearInterval(s),d.pause(),d.src="",t.current=null)},j)},[]),z=o.useCallback(()=>{m.current&&m.current.abort(),u.current.forEach(g=>{g.pause(),g.src=""}),u.current=[],t.current&&(t.current.pause(),t.current.src="",t.current=null),i(!1)},[]);return{play:x,stop:z,fadeOutAmbiance:r,isPlaying:n}}function se({title:n,icon:i,children:m,fullWidth:t}){const u=Q();return e.jsxs("div",{style:{background:u.bgC,border:`1px solid ${u.bd}`,borderRadius:10,padding:16,gridColumn:t?"1 / -1":void 0},children:[e.jsxs("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:u.dm,marginBottom:10,display:"flex",alignItems:"center",gap:6},children:[i," ",n]}),e.jsx("div",{style:{fontSize:13.5,lineHeight:1.6,color:u.mt},children:m})]})}function nt({scenario:n,language:i,difficulty:m,onLanguageChange:t,onDifficultyChange:u,onLaunch:x}){const r=Q();if(!n)return null;const z=n.persona,g=z.identite,d=g.entreprise,f=z.psychologie,S=z.contexte_actuel,j=n.objections,p=((j==null?void 0:j.objections)||[]).slice(0,6);return e.jsxs("div",{children:[e.jsxs("div",{className:"sim-brief-grid",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,marginBottom:24},children:[e.jsxs(se,{title:"Profil",icon:"üë§",children:[e.jsxs("strong",{style:{color:r.tx,fontWeight:600},children:[g.prenom," ",g.nom]}),", ",g.age||"?"," ans",e.jsx("br",{}),g.poste," chez ",e.jsx("strong",{style:{color:r.tx,fontWeight:600},children:d.nom}),e.jsx("br",{}),d.secteur," ‚Äî ",d.taille||"?"," ‚Äî CA ",d.ca_approximatif||"?"]}),e.jsxs(se,{title:"Psychologie",icon:"üß†",children:[e.jsx("strong",{style:{color:r.tx,fontWeight:600},children:"Traits :"})," ",f.traits_dominants.join(", "),e.jsx("br",{}),e.jsx("strong",{style:{color:r.tx,fontWeight:600},children:"Style :"})," ",f.style_communication,e.jsx("br",{}),e.jsx("strong",{style:{color:r.tx,fontWeight:600},children:"Rapport aux commerciaux :"})," ",f.rapport_aux_commerciaux||"?"]}),e.jsxs(se,{title:"Contexte",icon:"üìã",fullWidth:!0,children:[e.jsx("strong",{style:{color:r.tx,fontWeight:600},children:"Situation :"})," ",S.situation_entreprise,e.jsx("br",{}),e.jsx("strong",{style:{color:r.tx,fontWeight:600},children:"Priorit√©s :"})," ",(S.priorites_actuelles||[]).join(", "),e.jsx("br",{}),e.jsx("strong",{style:{color:r.tx,fontWeight:600},children:"Fournisseur actuel :"})," ",S.fournisseur_actuel||"Aucun",e.jsx("br",{}),e.jsx("strong",{style:{color:r.tx,fontWeight:600},children:"Budget :"})," ",S.budget_disponible||"?"]}),e.jsx(se,{title:"Objections √† anticiper",icon:"‚ö°",fullWidth:!0,children:p.length>0?e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:p.map((a,s)=>e.jsxs("div",{style:{background:r.bgE,border:`1px solid ${r.bd}`,borderRadius:6,padding:"10px 12px",fontSize:13,lineHeight:1.5},children:[e.jsx("span",{style:{fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:.8,color:r.ac,marginRight:8},children:a.moment}),e.jsxs("span",{style:{float:"right",fontSize:10,color:r.dm,fontFamily:"'JetBrains Mono', monospace"},children:["diff: ",a.difficulte,"/5"]}),e.jsx("br",{}),e.jsxs("span",{style:{color:r.tx,fontStyle:"italic"},children:['"',a.verbatim,'"']})]},s))}):"Aucune objection d√©finie."})]}),e.jsxs("div",{style:{marginBottom:24},children:[e.jsx("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:r.dm,marginBottom:10,textAlign:"center"},children:"Langue de la simulation"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"},children:He.map(a=>e.jsxs("button",{onClick:()=>t(a.code),style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 16px",borderRadius:20,fontSize:13,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:i===a.code?r.acD:"transparent",border:`1px solid ${i===a.code?r.ac:r.bd}`,color:i===a.code?r.ac:r.mt,boxShadow:i===a.code?`0 0 12px ${r.acD}`:"none",fontFamily:"inherit"},children:[e.jsx("span",{style:{fontSize:18,lineHeight:1},children:a.flag})," ",a.label]},a.code))})]}),e.jsxs("div",{style:{marginBottom:24},children:[e.jsx("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:r.dm,marginBottom:10,textAlign:"center"},children:"Niveau de difficult√©"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"},children:Ge.map(a=>{const s=m===a.value,A={1:r.ok,2:r.wr,3:r.dn},C={1:r.okD,2:r.wrD,3:r.dnD};return e.jsxs("button",{onClick:()=>u(a.value),style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4,padding:"10px 18px",borderRadius:20,fontSize:13,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:s?C[a.value]:"transparent",border:`1px solid ${s?A[a.value]:r.bd}`,color:s?A[a.value]:r.mt,boxShadow:s?`0 0 12px ${C[a.value]}`:"none",textAlign:"center",fontFamily:"inherit"},children:[e.jsxs("span",{style:{fontSize:13,fontWeight:600},children:[a.emoji," ",a.label]}),e.jsx("span",{style:{fontSize:10,fontWeight:400,color:s?"inherit":r.dm,maxWidth:170,lineHeight:1.3,opacity:s?.8:1},children:a.desc})]},a.value)})})]}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center",marginTop:28},children:e.jsx("button",{onClick:x,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:`linear-gradient(135deg, ${r.ac}, ${r.acL})`,color:"#fff",boxShadow:`0 4px 16px ${r.acD}`,fontFamily:"inherit"},children:"üéôÔ∏è Lancer la simulation"})})]})}const rt=[{value:"",label:"D√©tection automatique"},{value:"industrie",label:"Industrie / Manufacturing"},{value:"services",label:"Services aux entreprises"},{value:"tech",label:"Tech / SaaS / Digital"},{value:"commerce",label:"Commerce / Distribution"},{value:"sante",label:"Sant√© / M√©dical"},{value:"batiment",label:"BTP / B√¢timent"},{value:"finance",label:"Finance / Assurance / Banque"},{value:"formation",label:"Formation / √âducation"},{value:"immobilier",label:"Immobilier"},{value:"autre",label:"Autre"}],it=[{value:"prospection",label:"Prospection √† froid"},{value:"relance",label:"Relance / Suivi"},{value:"negociation",label:"N√©gociation"},{value:"reclamation",label:"R√©clamation client"},{value:"upsell",label:"Upsell / Cross-sell"}],ge=["√âtape 1/4 : Analyse de votre situation...","√âtape 2/4 : Cr√©ation du prospect...","√âtape 3/4 : G√©n√©ration des objections...","√âtape 4/4 : Pr√©paration du brief commercial..."];function ot({language:n,onBack:i,onLaunchScenario:m}){var P,T,M,J,B,X,G,b,L,U,I,Z,R,K,W;const t=Q(),{token:u}=ke(),[x,r]=o.useState(""),[z,g]=o.useState(""),[d,f]=o.useState("prospection"),[S,j]=o.useState(!1),[p,a]=o.useState(""),[s,A]=o.useState(null),C=o.useRef(null),q={width:"100%",padding:"10px 14px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:13,cursor:"pointer",fontFamily:"inherit"};async function D(){if(!x||x.length<30){alert("D√©crivez votre situation en au moins quelques phrases (30 caract√®res minimum).");return}j(!0),A(null),a(ge[0]);let h=0;C.current=setInterval(()=>{h=Math.min(h+1,ge.length-1),a(ge[h])},4e3);try{const $={"Content-Type":"application/json"};u&&($.Authorization="Bearer "+u);const ee=await fetch("/api/scenarios/generate",{method:"POST",headers:$,body:JSON.stringify({description:x,sector:z||null,type:d||"prospection",language:n})});clearInterval(C.current);const O=await ee.json();if(!ee.ok)throw new Error(O.detail||O.error||"Erreur serveur");A(O)}catch($){alert("Erreur lors de la g√©n√©ration : "+$.message)}finally{clearInterval(C.current),j(!1)}}return e.jsxs("div",{children:[e.jsx("h2",{style:{textAlign:"center",fontSize:22,fontWeight:700,marginBottom:8},children:"Cr√©ez votre sc√©nario de simulation"}),e.jsx("p",{style:{textAlign:"center",color:t.mt,fontSize:14,marginBottom:24,lineHeight:1.6},children:"D√©crivez la situation commerciale que vous voulez entra√Æner. L'IA g√©n√®re tout automatiquement : le prospect, ses objections et le brief commercial."}),!S&&!s&&e.jsxs(e.Fragment,{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:8,display:"block"},children:"D√©crivez votre situation commerciale"}),e.jsx("textarea",{value:x,onChange:h=>r(h.target.value),rows:6,placeholder:"Ex: Je vends des logiciels de comptabilit√© aux cabinets comptables de 5-20 personnes...",style:{width:"100%",padding:16,borderRadius:10,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,lineHeight:1.6,resize:"vertical",fontFamily:"inherit",outline:"none"}}),e.jsxs("div",{className:"sim-creator-options",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,margin:"18px 0"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:6,display:"block"},children:"Secteur (optionnel)"}),e.jsx("select",{value:z,onChange:h=>g(h.target.value),style:q,children:rt.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))})]}),e.jsxs("div",{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:6,display:"block"},children:"Type d'appel"}),e.jsx("select",{value:d,onChange:h=>f(h.target.value),style:q,children:it.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))})]})]})]}),S&&e.jsxs("div",{style:{textAlign:"center",padding:"32px 20px"},children:[e.jsx("div",{style:{display:"inline-block",width:36,height:36,border:`3px solid ${t.bd}`,borderTopColor:t.ac,borderRadius:"50%",animation:"spin 0.6s linear infinite",marginBottom:16}}),e.jsx("style",{children:"@keyframes spin { to { transform: rotate(360deg); } }"}),e.jsx("div",{style:{fontSize:15,fontWeight:600,marginBottom:4},children:"G√©n√©ration en cours..."}),e.jsx("div",{style:{fontSize:12,color:t.dm},children:"L'IA cr√©e votre prospect, ses objections et le brief commercial."}),e.jsx("div",{style:{fontSize:13,color:t.ac,fontWeight:600,marginTop:8},children:p})]}),s&&e.jsxs("div",{style:{background:t.bgC,border:`1px solid ${t.bd}`,borderRadius:14,padding:24,marginTop:20},children:[e.jsx("h3",{style:{fontSize:18,fontWeight:700,marginBottom:16,color:t.ok},children:"Sc√©nario g√©n√©r√© avec succ√®s"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,fontSize:14,color:t.mt,marginBottom:20},children:[e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Prospect :"})," ",(T=(P=s.persona)==null?void 0:P.identite)==null?void 0:T.prenom," ",(J=(M=s.persona)==null?void 0:M.identite)==null?void 0:J.nom,", ",(X=(B=s.persona)==null?void 0:B.identite)==null?void 0:X.poste]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Entreprise :"})," ",(L=(b=(G=s.persona)==null?void 0:G.identite)==null?void 0:b.entreprise)==null?void 0:L.nom," ‚Äî ",(Z=(I=(U=s.persona)==null?void 0:U.identite)==null?void 0:I.entreprise)==null?void 0:Z.secteur]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Titre :"})," ",((R=s.brief_commercial)==null?void 0:R.titre)||"Sc√©nario personnalis√©"]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Objections :"})," ",((W=(K=s.objections)==null?void 0:K.objections)==null?void 0:W.length)||"?"," objections g√©n√©r√©es"]})]}),e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",flexWrap:"wrap"},children:[e.jsx("button",{onClick:()=>m(s.id||s.scenario_id),style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",boxShadow:`0 4px 16px ${t.acD}`,fontFamily:"inherit"},children:"Lancer la simulation"}),e.jsx("button",{onClick:()=>{A(null),j(!1)},style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"Modifier et r√©g√©n√©rer"})]})]}),!S&&!s&&e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",marginTop:28},children:[e.jsx("button",{onClick:D,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",boxShadow:`0 4px 16px ${t.acD}`,fontFamily:"inherit"},children:"G√©n√©rer le sc√©nario"}),e.jsx("button",{onClick:i,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"Retour"})]})]})}function st({open:n,onClose:i,onLogin:m}){const t=Q();return n?e.jsx("div",{onClick:u=>{u.target===u.currentTarget&&i()},style:{position:"fixed",inset:0,zIndex:9999,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(6px)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{background:t.bgC,border:`1px solid ${t.bd}`,borderRadius:18,padding:"36px 32px",maxWidth:440,width:"90%",textAlign:"center",boxShadow:"0 24px 64px rgba(0,0,0,0.5)",position:"relative"},children:[e.jsx("button",{onClick:i,style:{position:"absolute",top:16,right:16,background:"none",border:"none",color:t.dm,fontSize:20,cursor:"pointer"},children:"√ó"}),e.jsx("div",{style:{fontSize:44,marginBottom:16},children:"üöÄ"}),e.jsx("div",{style:{fontSize:20,fontWeight:700,marginBottom:8},children:"Impressionn√© par votre simulation ?"}),e.jsxs("div",{style:{fontSize:14,color:t.mt,lineHeight:1.6,marginBottom:24},children:["Vous avez utilis√© votre simulation gratuite.",e.jsx("br",{}),"Cr√©ez un compte pour acc√©der √† ",e.jsx("strong",{style:{color:t.tx},children:"12 sc√©narios"}),", tous les niveaux de difficult√©, et suivre votre progression."]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:10},children:[e.jsx("a",{href:"/contact",style:{display:"block",padding:"14px 20px",borderRadius:6,background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",fontSize:14,fontWeight:600,textDecoration:"none",textAlign:"center",boxShadow:`0 4px 16px ${t.acD}`},children:"Cr√©er mon compte gratuitement"}),e.jsx("button",{onClick:m,style:{padding:"12px 20px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"J'ai d√©j√† un compte ‚Äî Se connecter"})]})]})}):null}function ut(){var Se,je;const n=Q(),{token:i}=ke(),m=Ue(),[t]=Ve(),u=t.get("scenario")||"__default__",x=t.get("demo")==="true",r=t.get("lang"),z=parseInt(t.get("difficulty"),10),g=!0,[d,f]=o.useState("loading"),[S,j]=o.useState(""),[p,a]=o.useState(null),[s,A]=o.useState(u),[C,q]=o.useState(r&&["fr","en","es","de","it"].includes(r)?r:"fr"),[D,P]=o.useState([1,2,3].includes(z)?z:2),[T,M]=o.useState(!1),[J,B]=o.useState(null),[X,G]=o.useState(0),[b,L]=o.useState(null),[U,I]=o.useState(!1),[Z,R]=o.useState(""),[K,W]=o.useState(null),[h,$]=o.useState(0),[ee,O]=o.useState(0),[ze,me]=o.useState(null),[ae,xe]=o.useState(null),he=o.useRef(null),le=o.useRef(0),te=Ke(),V=tt(),k=Ye(),F=o.useRef(null);o.useEffect(()=>{ce(u)},[u]);async function ce(c){var l;f("loading"),L(null),I(!1),R("");try{const w=await fetch("/api/scenarios/"+encodeURIComponent(c));if(!w.ok){const y=await w.json().catch(()=>({}));throw new Error(y.detail||"Sc√©nario introuvable")}const E=await w.json();a(E),A(c),!z&&!x&&P(((l=E.metadata)==null?void 0:l.difficulte_defaut)||2),f(x?"call":"briefing")}catch(w){j(w.message),f("error")}}async function be(){try{const c={"Content-Type":"application/json"};i&&(c.Authorization="Bearer "+i);const l=await fetch("/api/token",{method:"POST",headers:c,body:JSON.stringify({scenario_id:s!=="__default__"?s:null,difficulty:D,user_name:"Commercial",language:C,...x?{demo:!0}:{}})});l.ok&&(F.current=await l.json())}catch{}}const[Ee,ye]=o.useState(!1);o.useEffect(()=>{x&&d==="call"&&!F.current&&be()},[x,d]);function Ae(){f("call"),be()}o.useEffect(()=>{if(d==="postcall"&&b&&!U&&!i){const c=setTimeout(()=>ye(!0),8e3);return()=>clearTimeout(c)}},[d,b,U,i]);const de=(p==null?void 0:p._is_physical)||((Se=p==null?void 0:p.simulation)==null?void 0:Se.type)==="rdv_physique"||(p==null?void 0:p.scenario_type)==="rdv_physique";async function Te(){const c={tokenUrl:"/api/token",scenarioId:s!=="__default__"?s:null,difficulty:D,userName:"Commercial",language:C,authToken:i,prefetchedToken:F.current,...x?{demo:!0}:{}};if(de)try{await V.play(p);const l=await k.connect({...c,onPickup:()=>V.fadeOutAmbiance(2e3)});F.current=null,B(l.sessionDbId)}catch{F.current=null,V.stop()}else{await te.play();try{const l=await k.connect({...c,onPickup:()=>te.stop()});F.current=null,B(l.sessionDbId)}catch{F.current=null,te.stop()}}}function Ie(){te.stop(),V.stop();const c=k.disconnect(),l=k.transcriptEntries,w=l.length>0,E=c>3e3;w&&E?(G(c),f("postcall"),$e(c,l)):f("briefing")}function _e(c){try{let l=c.replace(/```json/g,"").replace(/```/g,"").trim();const w=l.indexOf("{"),E=l.lastIndexOf("}");if(w===-1)return null;if(E>w)try{const v=JSON.parse(l.slice(w,E+1));if(v&&typeof v.score_global=="number")return v}catch{}l=l.slice(w),l=l.replace(/,\s*$/,"");let y=0,Y=0;for(const v of l)v==="{"?y++:v==="}"?y--:v==="["?Y++:v==="]"&&Y--;l=l.replace(/,\s*$/,"");for(let v=0;v<Y;v++)l+="]";for(let v=0;v<y;v++)l+="}";const N=JSON.parse(l);return N&&typeof N.score_global=="number"?N:null}catch{return null}}function De(){le.current++;const c=Date.now()-he.current,l=Math.min(Math.floor(c/850),ie.length-1),w=Math.min(Math.floor(le.current/3),ie.length-1),E=Math.max(l,w);O(E);const y=Math.min(5+E/(ie.length-1)*90,95);$(Math.round(y))}function Re(c){L(c),I(!1),me(c.score_global),xe(c.eval_id||null),$(100),O(ie.length-1),W("revealing"),i||localStorage.setItem("vm-free-used","true")}function We(){W(null),ae&&i&&(window.location.href="/debrief?session="+ae)}async function $e(c,l){if(I(!0),R(""),L(null),me(null),xe(null),l.length<3){I(!1),R("Appel trop court pour √™tre √©valu√© (minimum 3 √©changes requis)");return}W("analyzing"),$(0),O(0),he.current=Date.now(),le.current=0;const w=l.map(y=>({role:y.who==="user"?"vendeur":"prospect",text:y.text,timestamp:y.time/1e3})),E=new Promise(y=>setTimeout(y,6e3));try{const y={"Content-Type":"application/json"};i&&(y.Authorization="Bearer "+i);const Y=(async()=>{const v=await fetch("/api/evaluate/stream",{method:"POST",headers:y,body:JSON.stringify({session_id:"free-"+s+"-"+Date.now(),transcript:w,scenario_id:s,difficulty:D,duration_s:Math.floor(c/1e3),session_db_id:J,language:C})});if(!v.ok){const H=await v.json().catch(()=>({}));throw new Error(H.detail||"Erreur serveur")}const Fe=v.body.getReader(),Ne=new TextDecoder;let ue="",pe="",ne=null;for(;;){const{done:H,value:qe}=await Fe.read();if(H)break;pe+=Ne.decode(qe,{stream:!0});const we=pe.split(`
`);pe=we.pop();for(const re of we){if(re.startsWith("event: done")||re.startsWith("event: error")||!re.startsWith("data: "))continue;const Je=re.slice(6);try{const _=JSON.parse(Je);if(_.type==="chunk")ue+=_.text,De();else{if(_.score_global!==void 0)return ne=_,ne;if(_.error)throw new Error(_.error)}}catch(_){if(_.message&&!_.message.includes("JSON"))throw _}}}if(!ne&&ue){const H=_e(ue);if(H)return H}return ne})(),[N]=await Promise.all([Y,E]);N&&typeof N.score_global=="number"?Re(N):(W(null),I(!1),i||localStorage.setItem("vm-free-used","true"))}catch(y){W(null),I(!1),R(y.message)}}function Pe(){L(null),I(!1),R(""),G(0),ce(s)}function Me(){if(!i){M(!0);return}f("creator")}function Be(c){m("/simulation?scenario="+encodeURIComponent(c)),ce(c)}const ve=((je=p==null?void 0:p.persona)==null?void 0:je.identite)||null,Le=(p==null?void 0:p.brief_commercial)||{},Oe=(()=>{const c=k.timer.split(":");return c.length!==2?0:parseInt(c[0],10)*60+parseInt(c[1],10)})();return e.jsxs("div",{style:{position:"relative",zIndex:1,maxWidth:860,margin:"0 auto",padding:"32px 24px",minHeight:"100vh"},children:[e.jsx("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:0,background:de&&d==="call"?"radial-gradient(ellipse at center, rgba(20,30,50,0.8) 0%, #080D1A 70%)":`radial-gradient(ellipse at 15% -10%, ${n.ac}12 0%, transparent 55%), radial-gradient(ellipse at 85% 110%, ${n.bl}0A 0%, transparent 55%)`}}),e.jsxs("div",{style:{textAlign:"center",marginBottom:36,position:"relative",zIndex:1},children:[e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:10,marginBottom:16},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:10,background:`linear-gradient(135deg, ${n.ac}, ${n.acL})`,display:"grid",placeItems:"center",fontWeight:800,fontSize:16,color:"#fff",boxShadow:`0 2px 16px ${n.acD}`},children:"VM"}),e.jsxs("div",{style:{fontSize:20,fontWeight:700,letterSpacing:-.5},children:["Vend",e.jsx("span",{style:{color:n.ac},children:"Mieux"})]})]}),e.jsx("div",{style:{fontSize:24,fontWeight:700,marginBottom:6,letterSpacing:-.3},children:d==="loading"?"Chargement...":Le.titre||"Simulation libre"}),e.jsx("div",{style:{color:n.mt,fontSize:14},children:"Simulation FORCE 3D ‚Äî Entra√Ænement commercial par IA"}),e.jsx("div",{style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:20,fontSize:12,fontWeight:600,background:n.acD,border:`1px solid ${n.ac}33`,color:n.ac,marginTop:12},children:"Mode libre"}),d!=="loading"&&e.jsx("div",{style:{marginTop:12},children:e.jsx("button",{onClick:Me,style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 16px",borderRadius:20,fontSize:12,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:"transparent",border:`1px solid ${n.ac}`,color:n.ac,fontFamily:"inherit"},children:"+ Cr√©er un sc√©nario"})})]}),e.jsxs("div",{style:{position:"relative",zIndex:1},children:[d==="loading"&&e.jsxs("div",{style:{textAlign:"center",padding:"80px 20px"},children:[e.jsx("div",{style:{display:"inline-block",width:36,height:36,border:`3px solid ${n.bd}`,borderTopColor:n.ac,borderRadius:"50%",animation:"spin 0.6s linear infinite"}}),e.jsx("style",{children:"@keyframes spin { to { transform: rotate(360deg); } }"})]}),d==="error"&&e.jsxs("div",{style:{textAlign:"center",padding:"80px 20px"},children:[e.jsx("div",{style:{fontSize:48,marginBottom:16},children:"‚ö†Ô∏è"}),e.jsx("div",{style:{fontSize:16,color:n.mt},children:S||"Lien invalide ou expir√©."})]}),d==="briefing"&&p&&e.jsx(nt,{scenario:p,language:C,difficulty:D,onLanguageChange:q,onDifficultyChange:P,onLaunch:Ae}),d==="call"&&e.jsx(Qe,{persona:ve,status:V.isPlaying?"intro":k.status,statusMsg:V.isPlaying?"Arriv√©e dans les locaux...":k.statusMsg,timer:k.timer,muted:k.muted,transcriptEntries:k.transcriptEntries,pendingSegments:k.pendingSegments,onStart:Te,onMute:k.toggleMute,onStop:Ie,isRdvPhysique:de,scenario:p,elapsedSeconds:Oe}),d==="postcall"&&e.jsx(Xe,{persona:ve,duration:X,transcriptEntries:k.transcriptEntries,evalLoading:U,evalError:Z,children:b&&e.jsx(Ze,{evaluation:b,transcriptEntries:k.transcriptEntries,isFreeMode:g})}),d==="creator"&&e.jsx(ot,{language:C,onBack:()=>f(p?"briefing":"loading"),onLaunchScenario:Be})]}),d==="postcall"&&e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",flexWrap:"wrap",marginTop:28},children:[b&&b.eval_id&&i&&e.jsx("a",{href:"/debrief?session="+b.eval_id,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",textDecoration:"none",background:`linear-gradient(135deg, ${n.ac}, ${n.acL})`,color:"#fff",boxShadow:`0 4px 16px ${n.acD}`,fontFamily:"inherit"},children:"üìä Voir le d√©brief complet"}),e.jsx("button",{onClick:Pe,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,fontSize:14,fontWeight:600,cursor:"pointer",background:b&&b.eval_id&&i?"transparent":`linear-gradient(135deg, ${n.ac}, ${n.acL})`,color:b&&b.eval_id&&i?n.mt:"#fff",border:b&&b.eval_id&&i?`1px solid ${n.bd}`:"none",boxShadow:b&&b.eval_id&&i?"none":`0 4px 16px ${n.acD}`,fontFamily:"inherit"},children:"üîÑ Nouvelle session"})]}),e.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",borderTop:`1px solid ${n.bd}`,marginTop:40},children:[e.jsx("div",{style:{color:n.mt,fontSize:14,marginBottom:12},children:"Cette simulation est propuls√©e par l'IA VendMieux"}),e.jsx("div",{style:{color:n.ac,fontSize:16,fontWeight:700},children:"Vous voulez √ßa pour vos √©tudiants ? Contactez-nous"})]}),K&&e.jsx(et,{phase:K,currentStep:ee,progress:h,score:ze,evalId:ae,onViewDebrief:We}),e.jsx(st,{open:T||Ee,onClose:()=>{M(!1),ye(!1)},onLogin:()=>{window.location.href="/login"}})]})}export{ut as default};
