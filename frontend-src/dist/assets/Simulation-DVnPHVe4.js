import{j as e,u as je}from"./index-C0xvUxL3.js";import{b as s,e as Ne,f as qe}from"./vendor-iPqs1NIt.js";import{u as Q}from"./shared-CqN-3ReB.js";import{L as Je,D as Ue,u as Ve,a as He,S as Ge,b as Ke,c as Ye,A as Qe,d as ie}from"./AnalysisModal-B9V680bS.js";async function Se(r){const i=await fetch("/api/tts/intro",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:r})});if(!i.ok)throw new Error("TTS failed");return(await i.json()).url}function pe(r,{volume:i=1,loop:f=!1}={}){return new Promise((t,d)=>{const h=new Audio(r);h.volume=i,h.loop=f,h.onended=()=>t(h),h.onerror=n=>d(n),h.play().then(()=>{f&&t(h)}).catch(d)})}function oe(r,i){return new Promise((f,t)=>{const d=setTimeout(f,r);i&&i.addEventListener("abort",()=>{clearTimeout(d),t(new DOMException("Aborted","AbortError"))},{once:!0})})}function Xe(){const[r,i]=s.useState(!1),f=s.useRef(null),t=s.useRef(null),d=s.useRef([]);s.useEffect(()=>()=>{f.current&&f.current.abort(),d.current.forEach(p=>{p.pause(),p.src=""}),d.current=[],t.current&&(t.current.pause(),t.current.src="",t.current=null)},[]);const h=s.useCallback(async p=>{var j;f.current&&f.current.abort();const b=new AbortController;f.current=b;const o=b.signal;i(!0);try{const g=((j=p==null?void 0:p.persona)==null?void 0:j.identite)||{},E=g.nom||"le prospect",u=(g.genre||"M")==="F"?"Madame":"Monsieur",C=(p==null?void 0:p.intro_assistante)||{},A=C.accueil||`Bonjour, vous avez rendez-vous avec ${u.toLowerCase()==="madame"?"madame":"monsieur"} ${E} ? Un instant je vous prie.`,B=C.introduction||`${u} ${E} vous re√ßoit, installez-vous.`,[L,O]=await Promise.all([Se(A),Se(B)]);if(o.aborted)throw new DOMException("Aborted","AbortError");const T=new Audio("/static/sounds/office-ambiance.mp3");if(T.loop=!0,T.volume=.15,t.current=T,d.current.push(T),await T.play(),o.aborted)throw new DOMException("Aborted","AbortError");await oe(1500,o);const F=await pe(L,{volume:.85});if(d.current.push(F),o.aborted)throw new DOMException("Aborted","AbortError");await oe(1e3,o);const D=await pe("/static/sounds/door_open.mp3",{volume:.7});if(d.current.push(D),o.aborted)throw new DOMException("Aborted","AbortError");await oe(500,o);const m=await pe(O,{volume:.85});if(d.current.push(m),o.aborted)throw new DOMException("Aborted","AbortError");await oe(500,o),i(!1)}catch(g){if(i(!1),g.name==="AbortError")return;throw g}},[]),n=s.useCallback((p=2e3)=>{const b=t.current;if(!b)return;const o=b.volume,j=20,g=p/j,E=o/j;let a=0;const u=setInterval(()=>{a++,b.volume=Math.max(0,o-E*a),a>=j&&(clearInterval(u),b.pause(),b.src="",t.current=null)},g)},[]),S=s.useCallback(()=>{f.current&&f.current.abort(),d.current.forEach(p=>{p.pause(),p.src=""}),d.current=[],t.current&&(t.current.pause(),t.current.src="",t.current=null),i(!1)},[]);return{play:h,stop:S,fadeOutAmbiance:n,isPlaying:r}}function se({title:r,icon:i,children:f,fullWidth:t}){const d=Q();return e.jsxs("div",{style:{background:d.bgC,border:`1px solid ${d.bd}`,borderRadius:10,padding:16,gridColumn:t?"1 / -1":void 0},children:[e.jsxs("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:d.dm,marginBottom:10,display:"flex",alignItems:"center",gap:6},children:[i," ",r]}),e.jsx("div",{style:{fontSize:13.5,lineHeight:1.6,color:d.mt},children:f})]})}function Ze({scenario:r,language:i,difficulty:f,onLanguageChange:t,onDifficultyChange:d,onLaunch:h}){const n=Q();if(!r)return null;const S=r.persona,p=S.identite,b=p.entreprise,o=S.psychologie,j=S.contexte_actuel,g=r.objections,E=((g==null?void 0:g.objections)||[]).slice(0,6);return e.jsxs("div",{children:[e.jsxs("div",{className:"sim-brief-grid",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,marginBottom:24},children:[e.jsxs(se,{title:"Profil",icon:"üë§",children:[e.jsxs("strong",{style:{color:n.tx,fontWeight:600},children:[p.prenom," ",p.nom]}),", ",p.age||"?"," ans",e.jsx("br",{}),p.poste," chez ",e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:b.nom}),e.jsx("br",{}),b.secteur," ‚Äî ",b.taille||"?"," ‚Äî CA ",b.ca_approximatif||"?"]}),e.jsxs(se,{title:"Psychologie",icon:"üß†",children:[e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Traits :"})," ",o.traits_dominants.join(", "),e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Style :"})," ",o.style_communication,e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Rapport aux commerciaux :"})," ",o.rapport_aux_commerciaux||"?"]}),e.jsxs(se,{title:"Contexte",icon:"üìã",fullWidth:!0,children:[e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Situation :"})," ",j.situation_entreprise,e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Priorit√©s :"})," ",(j.priorites_actuelles||[]).join(", "),e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Fournisseur actuel :"})," ",j.fournisseur_actuel||"Aucun",e.jsx("br",{}),e.jsx("strong",{style:{color:n.tx,fontWeight:600},children:"Budget :"})," ",j.budget_disponible||"?"]}),e.jsx(se,{title:"Objections √† anticiper",icon:"‚ö°",fullWidth:!0,children:E.length>0?e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:E.map((a,u)=>e.jsxs("div",{style:{background:n.bgE,border:`1px solid ${n.bd}`,borderRadius:6,padding:"10px 12px",fontSize:13,lineHeight:1.5},children:[e.jsx("span",{style:{fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:.8,color:n.ac,marginRight:8},children:a.moment}),e.jsxs("span",{style:{float:"right",fontSize:10,color:n.dm,fontFamily:"'JetBrains Mono', monospace"},children:["diff: ",a.difficulte,"/5"]}),e.jsx("br",{}),e.jsxs("span",{style:{color:n.tx,fontStyle:"italic"},children:['"',a.verbatim,'"']})]},u))}):"Aucune objection d√©finie."})]}),e.jsxs("div",{style:{marginBottom:24},children:[e.jsx("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:n.dm,marginBottom:10,textAlign:"center"},children:"Langue de la simulation"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"},children:Je.map(a=>e.jsxs("button",{onClick:()=>t(a.code),style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 16px",borderRadius:20,fontSize:13,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:i===a.code?n.acD:"transparent",border:`1px solid ${i===a.code?n.ac:n.bd}`,color:i===a.code?n.ac:n.mt,boxShadow:i===a.code?`0 0 12px ${n.acD}`:"none",fontFamily:"inherit"},children:[e.jsx("span",{style:{fontSize:18,lineHeight:1},children:a.flag})," ",a.label]},a.code))})]}),e.jsxs("div",{style:{marginBottom:24},children:[e.jsx("div",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:n.dm,marginBottom:10,textAlign:"center"},children:"Niveau de difficult√©"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",flexWrap:"wrap"},children:Ue.map(a=>{const u=f===a.value,C={1:n.ok,2:n.wr,3:n.dn},A={1:n.okD,2:n.wrD,3:n.dnD};return e.jsxs("button",{onClick:()=>d(a.value),style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4,padding:"10px 18px",borderRadius:20,fontSize:13,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:u?A[a.value]:"transparent",border:`1px solid ${u?C[a.value]:n.bd}`,color:u?C[a.value]:n.mt,boxShadow:u?`0 0 12px ${A[a.value]}`:"none",textAlign:"center",fontFamily:"inherit"},children:[e.jsxs("span",{style:{fontSize:13,fontWeight:600},children:[a.emoji," ",a.label]}),e.jsx("span",{style:{fontSize:10,fontWeight:400,color:u?"inherit":n.dm,maxWidth:170,lineHeight:1.3,opacity:u?.8:1},children:a.desc})]},a.value)})})]}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center",marginTop:28},children:e.jsx("button",{onClick:h,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:`linear-gradient(135deg, ${n.ac}, ${n.acL})`,color:"#fff",boxShadow:`0 4px 16px ${n.acD}`,fontFamily:"inherit"},children:"üéôÔ∏è Lancer la simulation"})})]})}const et=[{value:"",label:"D√©tection automatique"},{value:"industrie",label:"Industrie / Manufacturing"},{value:"services",label:"Services aux entreprises"},{value:"tech",label:"Tech / SaaS / Digital"},{value:"commerce",label:"Commerce / Distribution"},{value:"sante",label:"Sant√© / M√©dical"},{value:"batiment",label:"BTP / B√¢timent"},{value:"finance",label:"Finance / Assurance / Banque"},{value:"formation",label:"Formation / √âducation"},{value:"immobilier",label:"Immobilier"},{value:"autre",label:"Autre"}],tt=[{value:"prospection",label:"Prospection √† froid"},{value:"relance",label:"Relance / Suivi"},{value:"negociation",label:"N√©gociation"},{value:"reclamation",label:"R√©clamation client"},{value:"upsell",label:"Upsell / Cross-sell"}],fe=["√âtape 1/4 : Analyse de votre situation...","√âtape 2/4 : Cr√©ation du prospect...","√âtape 3/4 : G√©n√©ration des objections...","√âtape 4/4 : Pr√©paration du brief commercial..."];function nt({language:r,onBack:i,onLaunchScenario:f}){var O,T,F,D,m,$,N,I,X,R,G,W,Z,q,ee;const t=Q(),{token:d}=je(),[h,n]=s.useState(""),[S,p]=s.useState(""),[b,o]=s.useState("prospection"),[j,g]=s.useState(!1),[E,a]=s.useState(""),[u,C]=s.useState(null),A=s.useRef(null),B={width:"100%",padding:"10px 14px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:13,cursor:"pointer",fontFamily:"inherit"};async function L(){if(!h||h.length<30){alert("D√©crivez votre situation en au moins quelques phrases (30 caract√®res minimum).");return}g(!0),C(null),a(fe[0]);let x=0;A.current=setInterval(()=>{x=Math.min(x+1,fe.length-1),a(fe[x])},4e3);try{const J={"Content-Type":"application/json"};d&&(J.Authorization="Bearer "+d);const K=await fetch("/api/scenarios/generate",{method:"POST",headers:J,body:JSON.stringify({description:h,sector:S||null,type:b||"prospection",language:r})});clearInterval(A.current);const P=await K.json();if(!K.ok)throw new Error(P.detail||P.error||"Erreur serveur");C(P)}catch(J){alert("Erreur lors de la g√©n√©ration : "+J.message)}finally{clearInterval(A.current),g(!1)}}return e.jsxs("div",{children:[e.jsx("h2",{style:{textAlign:"center",fontSize:22,fontWeight:700,marginBottom:8},children:"Cr√©ez votre sc√©nario de simulation"}),e.jsx("p",{style:{textAlign:"center",color:t.mt,fontSize:14,marginBottom:24,lineHeight:1.6},children:"D√©crivez la situation commerciale que vous voulez entra√Æner. L'IA g√©n√®re tout automatiquement : le prospect, ses objections et le brief commercial."}),!j&&!u&&e.jsxs(e.Fragment,{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:8,display:"block"},children:"D√©crivez votre situation commerciale"}),e.jsx("textarea",{value:h,onChange:x=>n(x.target.value),rows:6,placeholder:"Ex: Je vends des logiciels de comptabilit√© aux cabinets comptables de 5-20 personnes...",style:{width:"100%",padding:16,borderRadius:10,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,lineHeight:1.6,resize:"vertical",fontFamily:"inherit",outline:"none"}}),e.jsxs("div",{className:"sim-creator-options",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,margin:"18px 0"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:6,display:"block"},children:"Secteur (optionnel)"}),e.jsx("select",{value:S,onChange:x=>p(x.target.value),style:B,children:et.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),e.jsxs("div",{children:[e.jsx("label",{style:{fontSize:11,fontWeight:700,letterSpacing:1,textTransform:"uppercase",color:t.dm,marginBottom:6,display:"block"},children:"Type d'appel"}),e.jsx("select",{value:b,onChange:x=>o(x.target.value),style:B,children:tt.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]})]})]}),j&&e.jsxs("div",{style:{textAlign:"center",padding:"32px 20px"},children:[e.jsx("div",{style:{display:"inline-block",width:36,height:36,border:`3px solid ${t.bd}`,borderTopColor:t.ac,borderRadius:"50%",animation:"spin 0.6s linear infinite",marginBottom:16}}),e.jsx("style",{children:"@keyframes spin { to { transform: rotate(360deg); } }"}),e.jsx("div",{style:{fontSize:15,fontWeight:600,marginBottom:4},children:"G√©n√©ration en cours..."}),e.jsx("div",{style:{fontSize:12,color:t.dm},children:"L'IA cr√©e votre prospect, ses objections et le brief commercial."}),e.jsx("div",{style:{fontSize:13,color:t.ac,fontWeight:600,marginTop:8},children:E})]}),u&&e.jsxs("div",{style:{background:t.bgC,border:`1px solid ${t.bd}`,borderRadius:14,padding:24,marginTop:20},children:[e.jsx("h3",{style:{fontSize:18,fontWeight:700,marginBottom:16,color:t.ok},children:"Sc√©nario g√©n√©r√© avec succ√®s"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,fontSize:14,color:t.mt,marginBottom:20},children:[e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Prospect :"})," ",(T=(O=u.persona)==null?void 0:O.identite)==null?void 0:T.prenom," ",(D=(F=u.persona)==null?void 0:F.identite)==null?void 0:D.nom,", ",($=(m=u.persona)==null?void 0:m.identite)==null?void 0:$.poste]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Entreprise :"})," ",(X=(I=(N=u.persona)==null?void 0:N.identite)==null?void 0:I.entreprise)==null?void 0:X.nom," ‚Äî ",(W=(G=(R=u.persona)==null?void 0:R.identite)==null?void 0:G.entreprise)==null?void 0:W.secteur]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Titre :"})," ",((Z=u.brief_commercial)==null?void 0:Z.titre)||"Sc√©nario personnalis√©"]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:t.tx},children:"Objections :"})," ",((ee=(q=u.objections)==null?void 0:q.objections)==null?void 0:ee.length)||"?"," objections g√©n√©r√©es"]})]}),e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",flexWrap:"wrap"},children:[e.jsx("button",{onClick:()=>f(u.id||u.scenario_id),style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",boxShadow:`0 4px 16px ${t.acD}`,fontFamily:"inherit"},children:"Lancer la simulation"}),e.jsx("button",{onClick:()=>{C(null),g(!1)},style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"Modifier et r√©g√©n√©rer"})]})]}),!j&&!u&&e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",marginTop:28},children:[e.jsx("button",{onClick:L,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",boxShadow:`0 4px 16px ${t.acD}`,fontFamily:"inherit"},children:"G√©n√©rer le sc√©nario"}),e.jsx("button",{onClick:i,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"Retour"})]})]})}function rt({open:r,onClose:i,onLogin:f}){const t=Q();return r?e.jsx("div",{onClick:d=>{d.target===d.currentTarget&&i()},style:{position:"fixed",inset:0,zIndex:9999,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(6px)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{background:t.bgC,border:`1px solid ${t.bd}`,borderRadius:18,padding:"36px 32px",maxWidth:440,width:"90%",textAlign:"center",boxShadow:"0 24px 64px rgba(0,0,0,0.5)",position:"relative"},children:[e.jsx("button",{onClick:i,style:{position:"absolute",top:16,right:16,background:"none",border:"none",color:t.dm,fontSize:20,cursor:"pointer"},children:"√ó"}),e.jsx("div",{style:{fontSize:44,marginBottom:16},children:"üöÄ"}),e.jsx("div",{style:{fontSize:20,fontWeight:700,marginBottom:8},children:"Impressionn√© par votre simulation ?"}),e.jsxs("div",{style:{fontSize:14,color:t.mt,lineHeight:1.6,marginBottom:24},children:["Vous avez utilis√© votre simulation gratuite.",e.jsx("br",{}),"Cr√©ez un compte pour acc√©der √† ",e.jsx("strong",{style:{color:t.tx},children:"12 sc√©narios"}),", tous les niveaux de difficult√©, et suivre votre progression."]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:10},children:[e.jsx("a",{href:"/contact",style:{display:"block",padding:"14px 20px",borderRadius:6,background:`linear-gradient(135deg, ${t.ac}, ${t.acL})`,color:"#fff",fontSize:14,fontWeight:600,textDecoration:"none",textAlign:"center",boxShadow:`0 4px 16px ${t.acD}`},children:"Cr√©er mon compte gratuitement"}),e.jsx("button",{onClick:f,style:{padding:"12px 20px",borderRadius:6,background:t.bgE,border:`1px solid ${t.bd}`,color:t.tx,fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},children:"J'ai d√©j√† un compte ‚Äî Se connecter"})]})]})}):null}function lt(){var be,ye;const r=Q(),{token:i}=je(),f=Ne(),[t]=qe(),d=t.get("scenario")||"__default__",h=!0,[n,S]=s.useState("loading"),[p,b]=s.useState(""),[o,j]=s.useState(null),[g,E]=s.useState(d),[a,u]=s.useState("fr"),[C,A]=s.useState(2),[B,L]=s.useState(!1),[O,T]=s.useState(null),[F,D]=s.useState(0),[m,$]=s.useState(null),[N,I]=s.useState(!1),[X,R]=s.useState(""),[G,W]=s.useState(null),[Z,q]=s.useState(0),[ee,x]=s.useState(0),[J,K]=s.useState(null),[P,ge]=s.useState(null),xe=s.useRef(null),ae=s.useRef(0),te=Ve(),U=Xe(),k=He(),V=s.useRef(null);s.useEffect(()=>{le(d)},[d]);async function le(c){var l;S("loading"),$(null),I(!1),R("");try{const w=await fetch("/api/scenarios/"+encodeURIComponent(c));if(!w.ok){const y=await w.json().catch(()=>({}));throw new Error(y.detail||"Sc√©nario introuvable")}const z=await w.json();j(z),E(c),A(((l=z.metadata)==null?void 0:l.difficulte_defaut)||2),S("briefing")}catch(w){b(w.message),S("error")}}async function we(){try{const c={"Content-Type":"application/json"};i&&(c.Authorization="Bearer "+i);const l=await fetch("/api/token",{method:"POST",headers:c,body:JSON.stringify({scenario_id:g!=="__default__"?g:null,difficulty:C,user_name:"Commercial",language:a})});l.ok&&(V.current=await l.json())}catch{}}const[Ce,me]=s.useState(!1);function ke(){S("call"),we()}s.useEffect(()=>{if(n==="postcall"&&m&&!N&&!i){const c=setTimeout(()=>me(!0),8e3);return()=>clearTimeout(c)}},[n,m,N,i]);const ce=(o==null?void 0:o._is_physical)||((be=o==null?void 0:o.simulation)==null?void 0:be.type)==="rdv_physique"||(o==null?void 0:o.scenario_type)==="rdv_physique";async function ze(){const c={tokenUrl:"/api/token",scenarioId:g!=="__default__"?g:null,difficulty:C,userName:"Commercial",language:a,authToken:i,prefetchedToken:V.current};if(ce)try{await U.play(o);const l=await k.connect({...c,onPickup:()=>U.fadeOutAmbiance(2e3)});V.current=null,T(l.sessionDbId)}catch{V.current=null,U.stop()}else{await te.play();try{const l=await k.connect({...c,onPickup:()=>te.stop()});V.current=null,T(l.sessionDbId)}catch{V.current=null,te.stop()}}}function Ee(){te.stop(),U.stop();const c=k.disconnect(),l=k.transcriptEntries,w=l.length>0,z=c>3e3;w&&z?(D(c),S("postcall"),Re(c,l)):S("briefing")}function Ae(c){try{let l=c.replace(/```json/g,"").replace(/```/g,"").trim();const w=l.indexOf("{"),z=l.lastIndexOf("}");if(w===-1)return null;if(z>w)try{const v=JSON.parse(l.slice(w,z+1));if(v&&typeof v.score_global=="number")return v}catch{}l=l.slice(w),l=l.replace(/,\s*$/,"");let y=0,Y=0;for(const v of l)v==="{"?y++:v==="}"?y--:v==="["?Y++:v==="]"&&Y--;l=l.replace(/,\s*$/,"");for(let v=0;v<Y;v++)l+="]";for(let v=0;v<y;v++)l+="}";const M=JSON.parse(l);return M&&typeof M.score_global=="number"?M:null}catch{return null}}function Te(){ae.current++;const c=Date.now()-xe.current,l=Math.min(Math.floor(c/850),ie.length-1),w=Math.min(Math.floor(ae.current/3),ie.length-1),z=Math.max(l,w);x(z);const y=Math.min(5+z/(ie.length-1)*90,95);q(Math.round(y))}function Ie(c){$(c),I(!1),K(c.score_global),ge(c.eval_id||null),q(100),x(ie.length-1),W("revealing"),i||localStorage.setItem("vm-free-used","true")}function _e(){W(null),P&&i&&(window.location.href="/debrief?session="+P)}async function Re(c,l){if(I(!0),R(""),$(null),K(null),ge(null),l.length<3){I(!1),R("Appel trop court pour √™tre √©valu√© (minimum 3 √©changes requis)");return}W("analyzing"),q(0),x(0),xe.current=Date.now(),ae.current=0;const w=l.map(y=>({role:y.who==="user"?"vendeur":"prospect",text:y.text,timestamp:y.time/1e3})),z=new Promise(y=>setTimeout(y,6e3));try{const y={"Content-Type":"application/json"};i&&(y.Authorization="Bearer "+i);const Y=(async()=>{const v=await fetch("/api/evaluate/stream",{method:"POST",headers:y,body:JSON.stringify({session_id:"free-"+g+"-"+Date.now(),transcript:w,scenario_id:g,difficulty:C,duration_s:Math.floor(c/1e3),session_db_id:O,language:a})});if(!v.ok){const H=await v.json().catch(()=>({}));throw new Error(H.detail||"Erreur serveur")}const Be=v.body.getReader(),Le=new TextDecoder;let de="",ue="",ne=null;for(;;){const{done:H,value:Oe}=await Be.read();if(H)break;ue+=Le.decode(Oe,{stream:!0});const ve=ue.split(`
`);ue=ve.pop();for(const re of ve){if(re.startsWith("event: done")||re.startsWith("event: error")||!re.startsWith("data: "))continue;const Fe=re.slice(6);try{const _=JSON.parse(Fe);if(_.type==="chunk")de+=_.text,Te();else{if(_.score_global!==void 0)return ne=_,ne;if(_.error)throw new Error(_.error)}}catch(_){if(_.message&&!_.message.includes("JSON"))throw _}}}if(!ne&&de){const H=Ae(de);if(H)return H}return ne})(),[M]=await Promise.all([Y,z]);M&&typeof M.score_global=="number"?Ie(M):(W(null),I(!1),i||localStorage.setItem("vm-free-used","true"))}catch(y){W(null),I(!1),R(y.message)}}function We(){$(null),I(!1),R(""),D(0),le(g)}function De(){if(!i){L(!0);return}S("creator")}function $e(c){f("/simulation?scenario="+encodeURIComponent(c)),le(c)}const he=((ye=o==null?void 0:o.persona)==null?void 0:ye.identite)||null,Pe=(o==null?void 0:o.brief_commercial)||{},Me=(()=>{const c=k.timer.split(":");return c.length!==2?0:parseInt(c[0],10)*60+parseInt(c[1],10)})();return e.jsxs("div",{style:{position:"relative",zIndex:1,maxWidth:860,margin:"0 auto",padding:"32px 24px",minHeight:"100vh"},children:[e.jsx("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:0,background:ce&&n==="call"?"radial-gradient(ellipse at center, rgba(20,30,50,0.8) 0%, #080D1A 70%)":`radial-gradient(ellipse at 15% -10%, ${r.ac}12 0%, transparent 55%), radial-gradient(ellipse at 85% 110%, ${r.bl}0A 0%, transparent 55%)`}}),e.jsxs("div",{style:{textAlign:"center",marginBottom:36,position:"relative",zIndex:1},children:[e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:10,marginBottom:16},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:10,background:`linear-gradient(135deg, ${r.ac}, ${r.acL})`,display:"grid",placeItems:"center",fontWeight:800,fontSize:16,color:"#fff",boxShadow:`0 2px 16px ${r.acD}`},children:"VM"}),e.jsxs("div",{style:{fontSize:20,fontWeight:700,letterSpacing:-.5},children:["Vend",e.jsx("span",{style:{color:r.ac},children:"Mieux"})]})]}),e.jsx("div",{style:{fontSize:24,fontWeight:700,marginBottom:6,letterSpacing:-.3},children:n==="loading"?"Chargement...":Pe.titre||"Simulation libre"}),e.jsx("div",{style:{color:r.mt,fontSize:14},children:"Simulation FORCE 3D ‚Äî Entra√Ænement commercial par IA"}),e.jsx("div",{style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:20,fontSize:12,fontWeight:600,background:r.acD,border:`1px solid ${r.ac}33`,color:r.ac,marginTop:12},children:"Mode libre"}),n!=="loading"&&e.jsx("div",{style:{marginTop:12},children:e.jsx("button",{onClick:De,style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 16px",borderRadius:20,fontSize:12,fontWeight:600,cursor:"pointer",transition:"all 0.15s",background:"transparent",border:`1px solid ${r.ac}`,color:r.ac,fontFamily:"inherit"},children:"+ Cr√©er un sc√©nario"})})]}),e.jsxs("div",{style:{position:"relative",zIndex:1},children:[n==="loading"&&e.jsxs("div",{style:{textAlign:"center",padding:"80px 20px"},children:[e.jsx("div",{style:{display:"inline-block",width:36,height:36,border:`3px solid ${r.bd}`,borderTopColor:r.ac,borderRadius:"50%",animation:"spin 0.6s linear infinite"}}),e.jsx("style",{children:"@keyframes spin { to { transform: rotate(360deg); } }"})]}),n==="error"&&e.jsxs("div",{style:{textAlign:"center",padding:"80px 20px"},children:[e.jsx("div",{style:{fontSize:48,marginBottom:16},children:"‚ö†Ô∏è"}),e.jsx("div",{style:{fontSize:16,color:r.mt},children:p||"Lien invalide ou expir√©."})]}),n==="briefing"&&o&&e.jsx(Ze,{scenario:o,language:a,difficulty:C,onLanguageChange:u,onDifficultyChange:A,onLaunch:ke}),n==="call"&&e.jsx(Ge,{persona:he,status:U.isPlaying?"intro":k.status,statusMsg:U.isPlaying?"Arriv√©e dans les locaux...":k.statusMsg,timer:k.timer,muted:k.muted,transcriptEntries:k.transcriptEntries,pendingSegments:k.pendingSegments,onStart:ze,onMute:k.toggleMute,onStop:Ee,isRdvPhysique:ce,scenario:o,elapsedSeconds:Me}),n==="postcall"&&e.jsx(Ke,{persona:he,duration:F,transcriptEntries:k.transcriptEntries,evalLoading:N,evalError:X,children:m&&e.jsx(Ye,{evaluation:m,transcriptEntries:k.transcriptEntries,isFreeMode:h})}),n==="creator"&&e.jsx(nt,{language:a,onBack:()=>S(o?"briefing":"loading"),onLaunchScenario:$e})]}),n==="postcall"&&e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center",flexWrap:"wrap",marginTop:28},children:[m&&m.eval_id&&i&&e.jsx("a",{href:"/debrief?session="+m.eval_id,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,border:"none",fontSize:14,fontWeight:600,cursor:"pointer",textDecoration:"none",background:`linear-gradient(135deg, ${r.ac}, ${r.acL})`,color:"#fff",boxShadow:`0 4px 16px ${r.acD}`,fontFamily:"inherit"},children:"üìä Voir le d√©brief complet"}),e.jsx("button",{onClick:We,style:{display:"inline-flex",alignItems:"center",gap:7,padding:"12px 24px",borderRadius:6,fontSize:14,fontWeight:600,cursor:"pointer",background:m&&m.eval_id&&i?"transparent":`linear-gradient(135deg, ${r.ac}, ${r.acL})`,color:m&&m.eval_id&&i?r.mt:"#fff",border:m&&m.eval_id&&i?`1px solid ${r.bd}`:"none",boxShadow:m&&m.eval_id&&i?"none":`0 4px 16px ${r.acD}`,fontFamily:"inherit"},children:"üîÑ Nouvelle session"})]}),e.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",borderTop:`1px solid ${r.bd}`,marginTop:40},children:[e.jsx("div",{style:{color:r.mt,fontSize:14,marginBottom:12},children:"Cette simulation est propuls√©e par l'IA VendMieux"}),e.jsx("div",{style:{color:r.ac,fontSize:16,fontWeight:700},children:"Vous voulez √ßa pour vos √©tudiants ? Contactez-nous"})]}),G&&e.jsx(Qe,{phase:G,currentStep:ee,progress:Z,score:J,evalId:P,onViewDebrief:_e}),e.jsx(rt,{open:B||Ce,onClose:()=>{L(!1),me(!1)},onLogin:()=>{window.location.href="/login"}})]})}export{lt as default};
